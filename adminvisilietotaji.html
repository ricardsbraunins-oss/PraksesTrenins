<script type="module">
import { supabase } from './supabase.js';

// ADMIN CHECK
const currentUser = localStorage.getItem("username");
if (currentUser !== "admin") {
  alert("Access denied! Only admin can view this page.");
  window.location.href = "index.html";
}

async function loadUsers() {
  const { data, error } = await supabase
    .from('users')
    .select('*');

  if (error) {
    alert("Error: " + error.message);
    return;
  }

  const table = document.getElementById("users");

  data.forEach(row => {
    const newRow = table.insertRow();

    // ID
    newRow.insertCell(0).innerText = row.id;

    // USERNAME
    newRow.insertCell(1).innerText = row.username;

    // PASSWORD (hidden)
    const passCell = newRow.insertCell(2);
    passCell.innerText = "*****";

    // SHOW/HIDE PASSWORD BUTTON
    const showCell = newRow.insertCell(3);
    const showBtn = document.createElement("button");
    showBtn.innerText = "Show";
    showBtn.style.width = "80px";

    let showing = false;

    showBtn.addEventListener("click", () => {
      if (!showing) {
        passCell.innerText = row.password;
        showBtn.innerText = "Hide";
        showing = true;
      } else {
        passCell.innerText = "*****";
        showBtn.innerText = "Show";
        showing = false;
      }
    });

    showCell.appendChild(showBtn);

    // CHANGE PASSWORD BUTTON
    const changePassCell = newRow.insertCell(4);
    const changeBtn = document.createElement("button");
    changeBtn.innerText = "Mainīt";
    changeBtn.style.width = "80px";
    changeBtn.style.color = "blue";

    changeBtn.addEventListener("click", async () => {
      const newPass = prompt("Ievadi jauno paroli:");

      if (!newPass || newPass.trim() === "") {
        alert("Parole nevar būt tukša!");
        return;
      }

      const { error } = await supabase
        .from("users")
        .update({ password: newPass })
        .eq("id", row.id);

      if (error) {
        alert("Kļūda mainot paroli: " + error.message);
        return;
      }

      row.password = newPass;
      passCell.innerText = "*****";
      showBtn.innerText = "Show";
      showing = false;

      alert("Parole veiksmīgi nomainīta!");
    });

    changePassCell.appendChild(changeBtn);

    // DELETE BUTTON
    const deleteCell = newRow.insertCell(5);
    const deleteBtn = document.createElement("button");
    deleteBtn.style.width = "80px";
    deleteBtn.innerText = "X";
    deleteBtn.style.color = "red";

    deleteBtn.addEventListener("click", async () => {
      if (!confirm("Tiešām dzēst šo lietotāju?")) return;

      await supabase
        .from("users")
        .delete()
        .eq("id", row.id);

      newRow.remove();
    });

    deleteCell.appendChild(deleteBtn);

  });
}

loadUsers();
</script>
