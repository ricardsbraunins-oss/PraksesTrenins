<!DOCTYPE html>
<html>
<head>
  <title>AdminVisiLietotāji</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div id="userDisplay" style="
  position: fixed;
  top: 10px;
  right: 15px;
  font-size: 18px;
  color: #00eaff;
"></div>

<h2>Visi saites users</h2>
<p style="color:red;">Tikai administratoram!</p>
<br>

<table border="1" id="users">
  <tr>
    <th>id</th>
    <th>username</th>
    <th>password</th>
    <th>mainīt paroli</th>
    <th>dzēst</th>
  </tr>
</table>

<br>
<button onclick="window.location.href='index.html'">Atpakaļ!</button>

<script>
// show username at top right
document.getElementById("userDisplay").innerText = localStorage.getItem("username");
</script>

<script type="module">
import { supabase } from './supabase.js';

// ADMIN CHECK
const currentUser = localStorage.getItem("username");
if (currentUser !== "admin") {
  alert("Access denied! Only admin can view this page.");
  window.location.href = "index.html";
}

// MAIN FUNCTION
async function loadUsers() {
  const { data, error } = await supabase
    .from('users')
    .select('*');

  if (error) {
    alert("Error: " + error.message);
    return;
  }

  const table = document.getElementById("users");

  data.forEach(row => {
    const newRow = table.insertRow();

    newRow.insertCell(0).innerText = row.id;
    newRow.insertCell(1).innerText = row.username;
    newRow.insertCell(2).innerText = row.password;

    // DELETE BUTTON
    const deleteCell = newRow.insertCell(3);
    const deleteBtn = document.createElement("button");
    deleteBtn.style.width = "80px";
    deleteBtn.innerText = "X";
    deleteBtn.style.color = "red";

    deleteBtn.addEventListener("click", async () => {
      if (!confirm("Tiešām dzēst šo lietotāju?")) return;

      await supabase
        .from("users")
        .delete()
        .eq("id", row.id);

      newRow.remove();
    });

    deleteCell.appendChild(deleteBtn);
  });
}

// CHANGE PASSWORD BUTTON
const changePassCell = newRow.insertCell(3);
const changeBtn = document.createElement("button");
changeBtn.innerText = "Mainīt";
changeBtn.style.width = "80px";
changeBtn.style.color = "blue";

changeBtn.addEventListener("click", async () => {
  const newPass = prompt("Ievadi jauno paroli:");

  if (!newPass || newPass.trim() === "") {
    alert("Parole nevar būt tukša!");
    return;
  }

  const { error } = await supabase
    .from("users")
    .update({ password: newPass })
    .eq("id", row.id);

  if (error) {
    alert("Kļūda mainot paroli: " + error.message);
    return;
  }

  newRow.cells[2].innerText = newPass; // update table visually
  alert("Parole veiksmīgi nomainīta!");
});

changePassCell.appendChild(changeBtn);
  

loadUsers();
</script>

</body>
</html>
