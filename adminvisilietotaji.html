<!DOCTYPE html>
<html>
<head>
  <title>AdminVisiLietotﾄ）i</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- Username shown in top-right -->
<div id="userDisplay" style="
  position: fixed;
  top: 10px;
  right: 15px;
  font-size: 18px;
  color: #00eaff;
"></div>

<h2>Visi saites lietotﾄ）i</h2>
<p style="color:red;">Tikai administratoram!</p>
<br>

<table border="1" id="users">
  <tr>
    <th>id</th>
    <th>username</th>
    <th>password</th>
    <th>Show</th>
    <th>Mainﾄｫt paroli</th>
    <th>Dzﾄ都t</th>
  </tr>
</table>

<br>
<button onclick="window.location.href='index.html'">Atpakaﾄｼ!</button>

<script>
// Show logged-in username
document.getElementById("userDisplay").innerText = localStorage.getItem("username");
</script>

<script type="module">
import { supabase } from './supabase.js';

// 沐 ADMIN CHECK
const currentUser = localStorage.getItem("username");
if (currentUser !== "admin") {
  alert("Access denied! Only admin can view this page.");
  window.location.href = "index.html";
}

// 沐ｧ MAIN FUNCTION: Load all users
async function loadUsers() {
  const { data, error } = await supabase
    .from('users')
    .select('*');

  if (error) {
    alert("Error: " + error.message);
    return;
  }

  const table = document.getElementById("users");

  data.forEach(row => {
    const newRow = table.insertRow();

    // ID
    newRow.insertCell(0).innerText = row.id;

    // Username
    newRow.insertCell(1).innerText = row.username;

    // Password (hidden)
    const passCell = newRow.insertCell(2);
    passCell.innerText = "*****";

    // SHOW / HIDE PASSWORD BUTTON
    const showCell = newRow.insertCell(3);
    const showBtn = document.createElement("button");
    showBtn.innerText = "Show";
    showBtn.style.width = "80px";

    let showing = false;

    showBtn.addEventListener("click", () => {
      if (!showing) {
        passCell.innerText = row.password;
        showBtn.innerText = "Hide";
        showing = true;
      } else {
        passCell.innerText = "*****";
        showBtn.innerText = "Show";
        showing = false;
      }
    });

    showCell.appendChild(showBtn);

    // CHANGE PASSWORD BUTTON
    const changePassCell = newRow.insertCell(4);
    const changeBtn = document.createElement("button");
    changeBtn.innerText = "Mainﾄｫt";
    changeBtn.style.width = "80px";
    changeBtn.style.color = "blue";

    changeBtn.addEventListener("click", async () => {
      const newPass = prompt("Ievadi jauno paroli:");

      if (!newPass || newPass.trim() === "") {
        alert("Parole nevar bﾅｫt tukﾅ｡a!");
        return;
      }

      const { error } = await supabase
        .from("users")
        .update({ password: newPass })
        .eq("id", row.id);

      if (error) {
        alert("Kﾄｼﾅｫda mainot paroli: " + error.message);
        return;
      }

      // Update locally
      row.password = newPass;
      passCell.innerText = "*****";
      showBtn.innerText = "Show";
      showing = false;

      alert("Parole veiksmﾄｫgi nomainﾄｫta!");
    });

    changePassCell.appendChild(changeBtn);

    // DELETE USER BUTTON
    const deleteCell = newRow.insertCell(5);
    const deleteBtn = document.createElement("button");
    deleteBtn.innerText = "X";
    deleteBtn.style.width = "80px";
    deleteBtn.style.color = "red";

    deleteBtn.addEventListener("click", async () => {
      if (!confirm("Tieﾅ｡ﾄ［ dzﾄ都t ﾅ｡o lietotﾄ）u?")) return;

      await supabase
        .from("users")
        .delete()
        .eq("id", row.id);

      newRow.remove();
    });

    deleteCell.appendChild(deleteBtn);
  });
}

loadUsers();
</script>

</body>
</html>
