<!DOCTYPE html>
<html>
<head>
  <title>AdminVisiLietotāji</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- Parāda lietotājvārdu augšējā labajā stūrī -->
<div id="userDisplay" style="
  position: fixed;
  top: 10px;
  right: 15px;
  font-size: 18px;
  color: #00eaff;
"></div>

<h2>Visi saites lietotāji</h2>
<p style="color:red;">Tikai administratoram!</p>
<br>

<!-- Tabula visiem lietotājiem -->
<table border="1" id="users">
  <tr>
    <th>id</th>
    <th>username</th>
    <th>password</th>
    <th>Show</th>
    <th>Mainīt paroli</th>
    <th>Dzēst</th>
  </tr>
</table>

<br>
<button onclick="window.location.href='index.html'">Atpakaļ!</button>

<script>
// Parāda kurš lietotājs ir ielogojies
document.getElementById("userDisplay").innerText = localStorage.getItem("username")
</script>

<script type="module">
import { supabase } from './supabase.js'

// Pārbauda vai lietotājs ir admin
const currentUser = localStorage.getItem("username")
if (currentUser !== "admin") {
  alert("Access denied! Only admin can view this page.")
  window.location.href = "index.html"
}

// Ielādē visus lietotājus no supabase
async function loadUsers() {
  const { data, error } = await supabase
    .from('users')
    .select('*')

  // Ja Supabase atgriež kļūdu
  if (error) {
    alert("Error: " + error.message)
    return
  }

  const table = document.getElementById("users")

  // Ievieto katru lietotāju tabulā
  data.forEach(row => {
    const newRow = table.insertRow()

    // ID
    newRow.insertCell(0).innerText = row.id

    // Lietotājvārds
    newRow.insertCell(1).innerText = row.username

    // Parole paslēpta
    const passCell = newRow.insertCell(2)
    passCell.innerText = "*****"

    // Parādīt/slēpt paroli
    const showCell = newRow.insertCell(3)
    const showBtn = document.createElement("button")
    showBtn.innerText = "Show"
    showBtn.style.width = "80px"

    let showing = false

    showBtn.addEventListener("click", () => {
      if (!showing) {
        passCell.innerText = row.password
        showBtn.innerText = "Hide"
        showing = true
      } else {
        passCell.innerText = "*****"
        showBtn.innerText = "Show"
        showing = false
      }
    })

    showCell.appendChild(showBtn)

    // Paroles maiņas poga
    const changePassCell = newRow.insertCell(4)
    const changeBtn = document.createElement("button")
    changeBtn.innerText = "Mainīt"
    changeBtn.style.width = "80px"
    changeBtn.style.color = "blue"

    changeBtn.addEventListener("click", async () => {
      const newPass = prompt("Ievadi jauno paroli:")

      if (!newPass || newPass.trim() === "") {
        alert("Parole nevar būt tukša!")
        return
      }

      const { error } = await supabase
        .from("users")
        .update({ password: newPass })
        .eq("id", row.id)

      if (error) {
        alert("Kļūda mainot paroli: " + error.message)
        return
      }

      // Atjauno lokāli
      row.password = newPass
      passCell.innerText = "*****"
      showBtn.innerText = "Show"
      showing = false

      alert("Parole veiksmīgi nomainīta!")
    })

    changePassCell.appendChild(changeBtn)

    // Dzēšanas poga
    const deleteCell = newRow.insertCell(5)
    const deleteBtn = document.createElement("button")
    deleteBtn.innerText = "X"
    deleteBtn.style.width = "80px"
    deleteBtn.style.color = "red"

    deleteBtn.addEventListener("click", async () => {
      if (!confirm("Tiešām dzēst šo lietotāju?")) return

      await supabase
        .from("users")
        .delete()
        .eq("id", row.id)

      newRow.remove()
    })

    deleteCell.appendChild(deleteBtn)
  })
}

// Izsauc funkciju lai ielādētu lietotājus
loadUsers()
</script>

</body>
</html>
