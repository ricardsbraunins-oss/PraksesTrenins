<!DOCTYPE html>
<html>
<head>
  <title>Aptauja!</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- Parāda lietotājvārdu augšējā labajā stūrī -->
<div id="userDisplay" style="
  position: fixed;
  top: 10px;
  right: 15px;
  font-size: 18px;
  color: black;
"></div>

<h2>Aptauja!</h2>

<script>
  // Pārbauda vai lietotājs ir ielogojies
  if (!localStorage.getItem("username")) {
    window.location.href = "login.html"
  }

  // Parāda lietotājvārdu
  const username = localStorage.getItem("username")
  document.getElementById("userDisplay").innerText = username
</script>

<!-- Ievades lauki -->
<label>Kā tevi sauc?</label><br>
<input id="q1" type="text" minlength="3" required><br><br>

<label>Kas ir tava mīļākā krāsa?</label><br>
<input id="q2" type="text" minlength="3" required><br><br>

<label>Cik tev gadi?</label><br>
<input id="q3" type="number" min="1" required><br><br>

<label>Ar ko tu ikdienā pārvietojies?</label><br>
<input id="q4" type="text" minlength="3" required><br><br>

<label>Kur tu mācies/strādā?</label><br>
<input id="q5" type="text" minlength="3" required><br><br>

<label>Vai tu dzīvo dienesta viesnīcā?</label><br>
<input id="q6" type="text"><br><br>

<button id="send">Submit</button>

<br><br>
<button onclick="window.location.href='responses.html'">Skatīt visas atbildes.</button>
<button onclick="window.location.href='index.html'">Atpakaļ sākumā!</button>

<p id="message"></p>

<script type="module">
  import { supabase } from './supabase.js'

  // Cooldown funkcija pēc iesniegšanas
  function startCooldown(seconds) {
    const msgEl = document.getElementById("message")
    const sendBtn = document.getElementById("send")

    sendBtn.disabled = true
    let timeLeft = seconds
    msgEl.innerText = `Saved! Cooldown: ${timeLeft}s`

    const interval = setInterval(() => {
      timeLeft--
      msgEl.innerText = `Saved! Cooldown: ${timeLeft}s`

      if (timeLeft <= 0) {
        clearInterval(interval)
        msgEl.innerText = "Ready!"
        sendBtn.disabled = false
      }
    }, 1000)
  }

  // Poga iesniegt aptauju
  document.getElementById("send").addEventListener("click", async () => {
    const q1 = document.getElementById("q1").value
    const q2 = document.getElementById("q2").value
    const q3 = document.getElementById("q3").value
    const q4 = document.getElementById("q4").value
    const q5 = document.getElementById("q5").value
    const q6 = document.getElementById("q6").value

    // Teksta lauku pārbaude
    if (q1.length < 3 || q2.length < 3 || q4.length < 3 || q5.length < 3 || q6.length < 3) {
      document.getElementById("message").innerText = "Teksta laukos jābūt vismaz 3 simboliem!"
      return
    }

    // Vecuma pārbaude
    if (!q3 || q3 <= 0) {
      document.getElementById("message").innerText = "Vecumam jābūt pozitīvam ciparam!"
      return
    }

    // Saglabā datus Supabase
    const { error } = await supabase
      .from('responses')
      .insert([{ q1, q2, q3, q4, q5, q6 }])

    if (error) {
      document.getElementById("message").innerText = "Error: " + error.message
      return
    }

    // Pēc veiksmīgas saglabāšanas sāk cooldown
    startCooldown(10)
  })
</script>

</body>
</html>
