<!DOCTYPE html>
<html>
<head>
  <title>todo</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- Parāda lietotājvārdu augšējā labajā stūrī -->
<div id="userDisplay" style="
  position: fixed;
  top: 10px;
  right: 15px;
  font-size: 18px;
  color: black;
"></div>

<h2>To do list</h2>
<p>Veido savu ToDo listu. To var redzēt tikai tu un admins.</p>

<script>
  // Pārbauda vai lietotājs ir ielogojies
  if (!localStorage.getItem("username")) {
    window.location.href = "login.html"
  }

  // Parāda lietotājvārdu
  const username = localStorage.getItem("username")
  document.getElementById("userDisplay").innerText = username
</script>

<!-- Uzdevuma ievade -->
<label>Uzdevums</label><br>
<input id="uzd" type="text" minlength="5" required placeholder="Apraksti uzdevumu!"><br><br>

<label for="uzdveids">Uzdevuma veids:</label><br>
<select id="uzdveids">
  <option value="Skolas darbs">Skolas darbs</option>
  <option value="Mājas darbs">Mājas darbs</option>
  <option value="Personālais">Personālais</option>
</select><br><br>

<label for="svarigums">Uzdevuma svarīgums</label><br>
<select id="svarigums">
  <option value="Steidzams">Steidzams</option>
  <option value="Nedēļa pabeigšanai">Nedēļa pabeigšanai</option>
  <option value="Kad gribi pabeidz">Kad gribi pabeidz</option>
</select><br><br>

<button id="send">Submit</button>

<br><br>
<button onclick="window.location.href='todolist.html'">Skatīt visus uzd.</button>
<button onclick="window.location.href='index.html'">Atpakaļ sākumā!</button>

<p id="message"></p>

<script type="module">
  import { supabase } from './supabase.js'

  // Cooldown funkcija pēc uzdevuma iesniegšanas
  function startCooldown(seconds) {
    const msgEl = document.getElementById("message")
    const sendBtn = document.getElementById("send")

    sendBtn.disabled = true
    let timeLeft = seconds
    msgEl.innerText = `Saved! Cooldown: ${timeLeft}s`

    const interval = setInterval(() => {
      timeLeft--
      msgEl.innerText = `Saved! Cooldown: ${timeLeft}s`

      if (timeLeft <= 0) {
        clearInterval(interval)
        msgEl.innerText = "Ready!"
        sendBtn.disabled = false
      }
    }, 1000)
  }

  // Poga saglabāt uzdevumu
  document.getElementById("send").addEventListener("click", async () => {
    const uzd = document.getElementById("uzd").value
    const uzdveids = document.getElementById("uzdveids").value
    const svarigums = document.getElementById("svarigums").value
    const username = localStorage.getItem("username")

    // Minimālais garums
    if (uzd.length < 5) {
      document.getElementById("message").innerText = "Min 5 simboli!"
      return
    }

    // Saglabā uzdevumu datubāzē
    const { error } = await supabase
      .from('todolist')
      .insert([{ uzd, uzdveids, svarigums, username }])

    if (error) {
      document.getElementById("message").innerText = "Error: " + error.message
      return
    }

    // Cooldown 10s
    startCooldown(10)
  })
</script>

</body>
</html>
