<script type="module">
import { supabase } from './supabase.js';

// Cooldown function OUTSIDE the click event
function startCooldown(seconds) {
  const msgEl = document.getElementById("message");
  let timeLeft = seconds;
  msgEl.innerText = `Saved! Cooldown: ${timeLeft}s`;

  const interval = setInterval(() => {
    timeLeft--;
    msgEl.innerText = `Saved! Cooldown: ${timeLeft}s`;

    if (timeLeft <= 0) {
      clearInterval(interval);
      msgEl.innerText = "Ready!";
      document.getElementById("send").disabled = false; // Re-enable button
    }
  }, 1000);
}

document.getElementById("send").addEventListener("click", async () => {
  const uzd = document.getElementById("uzd").value;
  const uzdveids = document.getElementById("uzdveids").value;
  const svarigums = document.getElementById("svarigums").value;

  // Client validation
  if (uzd.length < 5) {
    document.getElementById("message").innerText = "Min 5 symbols!";
    return;
  }

  const sendBtn = document.getElementById("send");
  sendBtn.disabled = true;

  const { error } = await supabase
    .from('responses')
    .insert([{ uzd, uzdveids, svarigums }]);

  if (error) {
    document.getElementById("message").innerText = "Error: " + error.message;
    sendBtn.disabled = false;
    return;
  }

  // Cooldown starts only when saved successfully
  startCooldown(10);
});
</script>
