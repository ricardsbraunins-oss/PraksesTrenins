<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Supabase Upload with Progress</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<h2>Upload file</h2>
<input type="file" id="fileInput" />
<button id="uploadBtn">Upload</button>

<div id="progressContainer" style="width:300px; margin-top:10px; display:none;">
  <progress id="uploadProgress" value="0" max="100"></progress>
  <span id="progressText">0%</span>
</div>

<hr />

<h2>Files in bucket</h2>
<ul id="fileList"></ul>

<hr />

<button onclick="window.location.href='index.html'">Atpakaļ sākumā!</button>

<script type="module">
  import { supabase, supabaseUrl, supabaseAnonKey } from './supabase.js'

  const bucket = 'test'
  const fileList = document.getElementById('fileList')

  document.getElementById('uploadBtn').addEventListener('click', uploadFile)

  loadFiles()

  async function uploadFile() {
    const fileInput = document.getElementById('fileInput')
    const file = fileInput.files[0]

    if (!file) {
      alert('No file selected')
      return
    }

    const filePath = `${Date.now()}_${file.name}`

    const progressContainer = document.getElementById('progressContainer')
    const progressBar = document.getElementById('uploadProgress')
    const progressText = document.getElementById('progressText')

    progressContainer.style.display = 'block'
    progressBar.value = 0
    progressText.textContent = '0%'

    const url = `${supabaseUrl}/storage/v1/object/${bucket}/${encodeURIComponent(filePath)}`

    const xhr = new XMLHttpRequest()
    xhr.open('POST', url)

    xhr.setRequestHeader('apikey', supabaseAnonKey)
    xhr.setRequestHeader('Authorization', `Bearer ${supabaseAnonKey}`)

    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100)
        progressBar.value = percent
        progressText.textContent = `${percent}%`
      }
    }

    xhr.onload = () => {
      progressContainer.style.display = 'none'
      if (xhr.status === 200 || xhr.status === 201) {
        fileInput.value = ''
        loadFiles()
      } else {
        alert('Upload failed: ' + xhr.statusText)
      }
    }

    xhr.onerror = () => {
      progressContainer.style.display = 'none'
      alert('Upload error')
    }

    xhr.send(file)
  }

  async function loadFiles() {
    fileList.innerHTML = ''

    const { data, error } = await supabase.storage.from(bucket).list('', { limit: 100 })

    if (error) {
      alert(error.message)
      return
    }

    if (data.length === 0) {
      fileList.innerHTML = '<li>No files</li>'
      return
    }

    data.forEach(file => {
      const li = document.createElement('li')
      li.textContent = file.name

      const downloadBtn = document.createElement('button')
      downloadBtn.textContent = 'Download'
      downloadBtn.onclick = () => downloadFile(file.name)

      const deleteBtn = document.createElement('button')
      deleteBtn.textContent = 'Delete'
      deleteBtn.onclick = () => deleteFile(file.name)

      li.appendChild(downloadBtn)
      li.appendChild(deleteBtn)
      fileList.appendChild(li)
    })
  }

  function downloadFile(path) {
    const { data } = supabase.storage.from(bucket).getPublicUrl(path)
    window.open(data.publicUrl, '_blank')
  }

  async function deleteFile(path) {
    if (!confirm('Delete this file?')) return

    const { error } = await supabase.storage.from(bucket).remove([path])
    if (error) alert(error.message)
    else loadFiles()
  }
</script>

</body>
</html>
